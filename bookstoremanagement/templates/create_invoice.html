<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
        }
        .card-header {
            background-color: #007bff;
            color: #fff;
            font-weight: bold;
        }
        .btn-primary, .btn-success {
            border-radius: 50px;
        }
        .table thead {
            background-color: #f1f1f1;
        }
        .table th {
            text-align: center;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="card">
        <div class="card-header text-center">
            <h4>Tạo Hóa Đơn Mới</h4>
        </div>
        <div class="card-body">
            <form id="orderForm" onsubmit="generateInvoice(event)">
                <!-- Thông tin khách hàng -->
                <div class="mb-4 row">
                    <div class="col-md-6">
                        <label for="customerName" class="form-label">Họ tên khách hàng</label>
                        <input type="text" class="form-control" id="customerName" placeholder="Nhập họ tên khách hàng" required>
                    </div>
                    <div class="col-md-6">
                        <label for="orderDate" class="form-label">Ngày lập hóa đơn</label>
                        <input type="text" class="form-control" id="orderDate" readonly>
                    </div>
                </div>
                <!-- Nhân viên -->
                <div class="mb-4">
                    <label for="employee" class="form-label">Nhân viên lập hóa đơn</label>
                    <input type="text" class="form-control" id="employee" value="{{ current_user.name }}" readonly>
                </div>
                <!-- Danh sách sách -->
                <div id="bookItems">
                    <div class="book-item mb-3">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label class="form-label">Sách</label>
                                <select class="form-select book-select" required>
                                    <option value="">Chọn sách</option>
                                    {% for book in books %}
                                    <option value="{{ book.id }}"
                                            data-category="{{ book.category.name }}"
                                            data-price="{{ book.price }}">{{ book.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Thể loại</label>
                                <input type="text" class="form-control category-input" readonly>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Số lượng</label>
                                <input type="number" class="form-control quantity-input" min="1" placeholder="Nhập số lượng" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Đơn giá</label>
                                <input type="number" class="form-control price-input" readonly>
                            </div>
                            <div class="col-md-2 text-center">
                                <button type="button" class="btn btn-danger remove-item">Xóa</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Nút thêm sách -->
                <button type="button" class="btn btn-success mb-3 w-100" id="addItem">+ Thêm Sách</button>
                <!-- Nút tạo hóa đơn -->
                <button type="submit" class="btn btn-primary w-100">Tạo Hóa Đơn</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal hiển thị hóa đơn -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Hóa đơn bán sách</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="invoiceContent">
                    <!-- Nội dung hóa đơn sẽ được thêm vào đây -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="printInvoice()">In hóa đơn</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Set ngày hiện tại
    const today = new Date().toISOString().split('T')[0];

    // Thêm sách mới
    let booksData[];

    fetch('/data/books.json')
      .then((res) => res.json())
      .then((data) => {
      console.log(typeof data);
    .catch(error => console.error("Error fetching books data:", error));

    // Xoá mục sách
    removeButton.addEventListener('click', function() {
      if (document.querySelectorAll('.book-item').length > 1) {
        bookItem.remove();
      }
    });
  }

function generateInvoice(event) {
    event.preventDefault();

    const customerName = document.getElementById('customerName').value;
    const orderDate = document.getElementById('orderDate').value;
    const employee = document.getElementById('employee').value;

    let invoiceHtml = `
        <div class="text-center mb-4">
            <h4>HÓA ĐƠN BÁN SÁCH</h4>
        </div>
        <div class="row mb-3">
            <div class="col-6">Họ tên khách hàng: ${customerName}</div>
            <div class="col-6">Ngày lập hóa đơn: ${orderDate}</div>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Sách</th>
                    <th>Thể loại</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                </tr>
            </thead>
            <tbody>
    `;

    const bookItems = document.querySelectorAll('.book-item');
    let totalAmount = 0;

    bookItems.forEach((item, index) => {
        const bookName = item.querySelector('.book-select option:checked').text;
        const category = item.querySelector('.category-input').value;
        const quantity = item.querySelector('.quantity-input').value;
        const price = item.querySelector('.price-input').value;
        const itemTotal = quantity * price;
        totalAmount += itemTotal;

        invoiceHtml += `
            <tr>
                <td>${index + 1}</td>
                <td>${bookName}</td>
                <td>${category}</td>
                <td>${quantity}</td>
                <td>${price.toLocaleString('vi-VN')}đ</td>
            </tr>
        `;
    });

    invoiceHtml += `
            </tbody>
        </table>
        <div class="text-end">
            <strong>Tổng tiền: ${totalAmount.toLocaleString('vi-VN')}đ</strong>
        </div>
        <div class="mt-4">
            <div>Nhân viên thanh toán: ${employee}</div>
        </div>
    `;

    document.getElementById('invoiceContent').innerHTML = invoiceHtml;
    new bootstrap.Modal(document.getElementById('invoiceModal')).show();
}

function printInvoice() {
    const printContent = document.getElementById('invoiceContent').innerHTML;
    const originalContent = document.body.innerHTML;

    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;

    // Khởi động lại các sự kiện sau khi in
    document.addEventListener('DOMContentLoaded', function() {
        location.reload();
    });
}
</script>
</body>
</html>
